---
title: "Project 2"
author: "Ruiyang Hu"
date: "2025-11-16"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(lubridate)
library(here)
air_2018_raw <- read_csv("AQ_2018.csv")
air_2019_raw <- read_csv("AQ_2019.csv")
air_2020_raw <- read_csv("AQ_2020.csv")
```

## Function
Step 1 set a function
```{r, include=FALSE}
##clean data-2018
names(air_2018_raw)
air_2018_step1 <- air_2018_raw |>
  rename(
    date  = Date,
    co    = `Daily Max 8-hour CO Concentration`,
    pm25  = `Daily Mean PM2.5 Concentration`,
    o3    = `Daily Max 8-hour Ozone Concentration`,
    units_co   = units_CO,
    units_pm25 = units_PM,
    units_o3   = units_O3
  )
air_2018_step2 <- air_2018_step1 |>
  mutate(date = mdy(date))
class(air_2018_step2$date)
air_2018_step3 <- air_2018_step2 |>
  group_by(date) |>
  summarize(
    co = mean(co, na.rm = TRUE),
    pm25 = mean(pm25, na.rm = TRUE),
    o3 = mean(o3, na.rm = TRUE),
    .groups = "drop"
  )
air_2018_step4 <- air_2018_step3 |>
  distinct()
air_2018_clean <- air_2018_step4

pollutants <- c("co", "pm25", "o3")

for (p in pollutants) {
  air_2018_clean[[p]][air_2018_clean[[p]] < 0] <- 0
}
summary(air_2018_clean)

```

Step 2 Process 
```{r, echo=FALSE}
process_air <- function(raw_data) {
  

  data_renamed <- raw_data |>
    rename(
      date  = Date,
      co    = `Daily Max 8-hour CO Concentration`,
      pm25  = `Daily Mean PM2.5 Concentration`,
      o3    = `Daily Max 8-hour Ozone Concentration`,
      units_co   = units_CO,
      units_pm25 = units_PM,
      units_o3   = units_O3
    )
  

  data_date <- data_renamed |>
    mutate(date = mdy(date))
  
 
  data_daily <- data_date |>
    group_by(date) |>
    summarize(
      co   = mean(co,   na.rm = TRUE),
      pm25 = mean(pm25, na.rm = TRUE),
      o3   = mean(o3,   na.rm = TRUE),
      .groups = "drop"
    )
  

  data_nodup <- data_daily |>
    distinct()
  
  pollutants <- c("co", "pm25", "o3")
  for (p in pollutants) {
    data_nodup[[p]][data_nodup[[p]] < 0] <- 0
  }
  
  return(data_nodup)
}

air_2018 <- process_air(air_2018_raw) |>
  mutate(year = 2018)

air_2019 <- process_air(air_2019_raw) |>
  mutate(year = 2019)

air_2020 <- process_air(air_2020_raw) |>
  mutate(year = 2020)
```

Step 3 merge
```{r,echo=FALSE}
air_all <- bind_rows(air_2018, air_2019, air_2020) |>
  mutate(
    month = month(date),                                
    month_label = month(date, label = TRUE, abbr = TRUE, locale = "en_US") 
  )

head(air_all)
```

## Plot
1. Plot 1
```{r,echo=FALSE}
air_long <- air_all |>
  select(year, month, month_label, co, o3) |>
  pivot_longer(
    cols = c(co, o3),
    names_to = "pollutant",
    values_to = "value"
  )
#mean and CI
monthly_summary <- air_long |>
  group_by(month, month_label, pollutant) |>
  summarize(
    mean = mean(value, na.rm = TRUE),
    sd   = sd(value, na.rm = TRUE),
    n    = sum(!is.na(value)),
    se   = sd / sqrt(n),
    lower = mean - 1.96 * se,
    upper = mean + 1.96 * se,
    .groups = "drop"
  )
#plot1
plot1 <- ggplot(monthly_summary,
                aes(x = month_label, y = mean,
                    color = pollutant, group = pollutant)) +
  geom_point() +
  geom_line() +
  geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.1) +
  labs(
    title = "Monthly Average CO and O3 (2018â€“2020)",
    x = "Month",
    y = "Concentration",
    color = "Pollutant"
  ) +
  theme_minimal()

plot1

```



2. Plot 2
```{r,echo=FALSE}
pm25_monthly <- air_all |>
  group_by(year, month, month_label) |>
  summarize(
    mean_pm25 = mean(pm25, na.rm = TRUE),
    .groups = "drop"
  )
#plot 2
plot2 <- ggplot(pm25_monthly,
                aes(x = month_label, y = mean_pm25,
                    color = factor(year), group = year)) +
  geom_line() +
  geom_point() +
  labs(
    title = "Monthly Average PM2.5 by Year",
    x = "Month",
    y = "PM2.5 Concentration",
    color = "Year"
  ) +
  theme_minimal()

plot2

```
